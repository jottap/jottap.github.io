---
import Layout from "./Layout.astro";
import Navbar from "../components/Navbar";
import ProjectGallery from "../components/ProjectGallery";
import { ui } from "../i18n/ui";

// --- 1. Robust Data Extraction ---
const props = Astro.props;
const rawData = props.frontmatter || props.data || props;

// Destructure with default fallbacks
const {
    slug,
    title,
    desc,
    category = "Project",
    tech = [],
    metrics,
    cover_image,
    image,
    video_url,
    backers_image,
    backers = [], // Array de URLs
    store_links,
    i18n,
    gallery = [],
} = rawData;

// Detect Language
const pathname = Astro.url.pathname;
const isPt = pathname.includes("/pt/") || props.lang === "pt";
const lang = isPt ? "pt" : "en";

// Localized Content
const globalT = ui[lang];
const t = i18n?.[lang] || i18n?.en || {};
const finalTitle = t.title || title || "Untitled Project";
const finalSubtitle = t.subtitle || desc || "";

// Titles (Dynamic or Default Award-Winning Style)
const overviewTitle = t.overview_title || globalT["project.overview"];
const featuresTitle = t.key_features_title || globalT["project.features"];
const myRoleTitle = t.my_role_title || globalT["project.role"];
const myRoleText = t.my_role_summary;

// Assets
const heroImage = cover_image || image;
const hasVideo = !!video_url;
const hasBackers = !!backers_image;
const hasGallery = Array.isArray(gallery) && gallery.length > 0;
const hasStoreLinks = !!store_links;

// Helper: Basic Markdown Parser for Bold Text
function renderText(text: string) {
    if (!text) return [];
    return text.split(/(\*\*.*?\*\*)/).map((part) => {
        if (part.startsWith("**") && part.endsWith("**")) {
            return { type: "bold", content: part.slice(2, -2) };
        }
        return { type: "text", content: part };
    });
}

// Helper: Icon Selection for Features
function getFeatureIcon(title: string) {
    const lower = title.toLowerCase();
    if (lower.includes("cloud") || lower.includes("nuvem")) return "cloud";
    if (lower.includes("architect") || lower.includes("arquitetura"))
        return "architecture";
    if (
        lower.includes("optimiz") ||
        lower.includes("security") ||
        lower.includes("segurança")
    )
        return "shield";
    if (lower.includes("data") || lower.includes("dados")) return "database";
    return "code";
}

// Helper: Resolve Asset Path (Automatic directory lookup)
function resolveAssetPath(path: string, slug: string) {
    if (!path) return "";
    // If it's a full path (starts with / or http), keep it.
    if (path.startsWith("/") || path.startsWith("http")) return path;
    // Otherwise, assume it's relative to the project folder
    // otherwise
    return `/assets/projects/${slug}/${path}`;
}

// Smart Navigation Logic
const fromArchive = Astro.url.searchParams.get("from") === "archive";
const backLink = fromArchive
    ? "/archive"
    : lang === "pt"
      ? "/pt/#projects"
      : "/#projects";
const backText = fromArchive
    ? globalT["project.back_archive"]
    : globalT["project.back_home"];
---

<Layout title={`${finalTitle} | JOTTAP Portfolio`}>
    <Navbar client:load lang={lang} />

    {/* SMART BACK BUTTON (Floating Pill) */}
    <a
        href={backLink}
        class="fixed top-24 left-4 md:left-6 z-40 px-4 py-2 rounded-xl bg-black/40 backdrop-blur-md border border-white/10 text-sm font-medium hover:border-accent hover:text-white transition-all flex items-center gap-2 group shadow-2xl"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 text-forge-400 group-hover:text-white transition-colors"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        <span
            class="text-forge-200 group-hover:text-white transition-colors hidden md:inline"
        >
            {backText}
        </span>
    </a>

    <main
        class="min-h-screen bg-forge-950 font-sans selection:bg-accent selection:text-black pt-20"
    >
        {/* --- PREMIUM HEADER --- */}
        <header
            class="relative h-[45vh] min-h-[400px] w-full overflow-hidden flex items-end pb-12"
        >
            {/* Cover Image Background */}
            <div class="absolute inset-0 z-0">
                {
                    heroImage && (
                        <img
                            src={heroImage}
                            alt={finalTitle}
                            class="w-full h-full object-cover opacity-50"
                        />
                    )
                }
                <div
                    class="absolute inset-0 bg-gradient-to-t from-forge-950 via-forge-950/60 to-transparent"
                >
                </div>
            </div>

            <div
                class="relative z-10 w-full max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-12 gap-12 items-end"
            >
                <div class="lg:col-span-8 space-y-4">
                    {/* Category & Badge */}
                    <div class="flex items-center gap-3">
                        <span
                            class="inline-block px-3 py-1 text-xs font-bold uppercase tracking-widest text-accent border border-accent/20 bg-accent/5 rounded-xl backdrop-blur-sm"
                        >
                            {category}
                        </span>
                    </div>

                    <h1
                        class="text-5xl md:text-7xl font-display font-bold text-white leading-tight"
                    >
                        {finalTitle}
                    </h1>
                    {
                        finalSubtitle && (
                            <p class="text-xl text-forge-200 font-light max-w-2xl">
                                {finalSubtitle}
                            </p>
                        )
                    }
                </div>

                {/* Store Links (Right aligned in desktop) */}
                <div class="lg:col-span-4 lg:flex lg:justify-end lg:items-end">
                    {
                        hasStoreLinks && (
                            <div class="flex flex-wrap lg:flex-nowrap gap-3">
                                {store_links?.android && (
                                    <a
                                        href={store_links.android}
                                        target="_blank"
                                        class="flex items-center gap-3 px-4 py-2 bg-black/90 border border-white/10 rounded-xl hover:bg-black hover:border-white/30 transition-all group min-w-[160px]"
                                    >
                                        <svg
                                            class="w-8 h-8 text-white group-hover:text-[#3DDC84] transition-colors"
                                            viewBox="0 0 24 24"
                                            fill="currentColor"
                                        >
                                            <path d="M3,20.5V3.5C3,2.91,3.34,2.39,3.84,2.15L13.69,12L3.84,21.85C3.34,21.6,3,21.09,3,20.5M16.81,15.12L6.05,21.34L14.54,12.85L16.81,15.12M20.16,10.81C20.5,11.08,20.75,11.5,20.75,12C20.75,12.5,20.53,12.92,20.16,13.19L17.89,14.5L15.39,12L17.89,9.5L20.16,10.81M6.05,2.66L16.81,8.88L14.54,11.15L6.05,2.66Z" />
                                        </svg>
                                        <div class="flex flex-col">
                                            <span class="text-[10px] leading-none uppercase text-white/60">
                                                {
                                                    globalT[
                                                        "project.download_google"
                                                    ]
                                                }
                                            </span>
                                            <span class="text-lg font-bold leading-none text-white font-display">
                                                Google Play
                                            </span>
                                        </div>
                                    </a>
                                )}
                                {store_links?.ios && (
                                    <a
                                        href={store_links.ios}
                                        target="_blank"
                                        class="flex items-center gap-3 px-4 py-2 bg-black/90 border border-white/10 rounded-xl hover:bg-black hover:border-white/30 transition-all group min-w-[160px]"
                                    >
                                        <svg
                                            class="w-8 h-8 text-white group-hover:text-white transition-colors"
                                            viewBox="0 0 24 24"
                                            fill="currentColor"
                                        >
                                            <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.78 1.18-.19 2.31-.89 3.51-.84 1.54.06 2.74.83 3.44 1.74-2.89 1.43-2.3 5.79.56 6.79-.69 1.99-1.35 3.32-2.59 4.5zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z" />
                                        </svg>
                                        <div class="flex flex-col">
                                            <span class="text-[10px] leading-none uppercase text-white/60">
                                                {
                                                    globalT[
                                                        "project.download_apple"
                                                    ]
                                                }
                                            </span>
                                            <span class="text-lg font-bold leading-none text-white font-display">
                                                App Store
                                            </span>
                                        </div>
                                    </a>
                                )}
                                {store_links?.itch && (
                                    <a
                                        href={store_links.itch}
                                        target="_blank"
                                        class="flex items-center gap-3 px-4 py-2 bg-[#fa5c5c] text-white rounded-xl hover:bg-[#ff4d4d] hover:scale-105 transition-all shadow-lg shadow-red-500/20 group min-w-[160px]"
                                    >
                                        <svg
                                            class="w-8 h-8 fill-current"
                                            viewBox="0 0 24 24"
                                        >
                                            <path d="M3.13 1.338C2.08 1.96.02 4.328 0 4.95v1.03c0 1.303 1.22 2.45 2.325 2.45 1.33 0 2.436-1.102 2.436-2.41 0 1.308 1.07 2.41 2.4 2.41 1.328 0 2.362-1.102 2.362-2.41 0 1.308 1.137 2.41 2.466 2.41h.024c1.33 0 2.466-1.102 2.466-2.41 0 1.308 1.034 2.41 2.363 2.41 1.33 0 2.4-1.102 2.4-2.41 0 1.308 1.106 2.41 2.435 2.41C22.78 8.43 24 7.282 24 5.98V4.95c-.02-.62-2.082-2.99-3.13-3.612-3.253-.114-5.508-.134-8.87-.133-3.362 0-7.945.053-8.87.133zm6.376 6.477a2.74 2.74 0 0 1-.468.602c-.5.49-1.19.795-1.947.795a2.786 2.786 0 0 1-1.95-.795c-.182-.178-.32-.37-.446-.59-.127.222-.303.412-.486.59a2.788 2.788 0 0 1-1.95.795c-.092 0-.187-.025-.264-.052-.107 1.113-.152 2.176-.168 2.95v.005l-.006 1.167c.02 2.334-.23 7.564 1.03 8.85 1.952.454 5.545.662 9.15.663 3.605 0 7.198-.21 9.15-.664 1.26-1.284 1.01-6.514 1.03-8.848l-.006-1.167v-.004c-.016-.775-.06-1.838-.168-2.95-.077.026-.172.052-.263.052a2.788 2.788 0 0 1-1.95-.795c-.184-.178-.36-.368-.486-.59-.127.22-.265.412-.447.59a2.786 2.786 0 0 1-1.95.794c-.76 0-1.446-.303-1.948-.793a2.74 2.74 0 0 1-.468-.602 2.738 2.738 0 0 1-.463.602 2.787 2.787 0 0 1-1.95.794h-.16a2.787 2.787 0 0 1-1.95-.793 2.738 2.738 0 0 1-.464-.602zm-2.004 2.59v.002c.795.002 1.5 0 2.373.953.687-.072 1.406-.108 2.125-.107.72 0 1.438.035 2.125.107.873-.953 1.578-.95 2.372-.953.376 0 1.876 0 2.92 2.934l1.123 4.028c.832 2.995-.266 3.068-1.636 3.07-2.03-.075-3.156-1.55-3.156-3.025-1.124.184-2.436.276-3.748.277-1.312 0-2.624-.093-3.748-.277 0 1.475-1.125 2.95-3.156 3.026-1.37-.004-2.468-.077-1.636-3.072l1.122-4.027c1.045-2.934 2.545-2.934 2.92-2.934zM12 12.714c-.002.002-2.14 1.964-2.523 2.662l1.4-.056v1.22c0 .056.56.033 1.123.007.562.026 1.124.05 1.124-.008v-1.22l1.4.055C14.138 14.677 12 12.713 12 12.713z" />
                                        </svg>
                                        <div class="flex flex-col">
                                            <span class="text-[10px] leading-none uppercase text-white/80">
                                                {
                                                    globalT[
                                                        "project.download_google"
                                                    ]
                                                }
                                            </span>
                                            <span class="text-lg font-bold leading-none text-white font-display">
                                                itch.io
                                            </span>
                                        </div>
                                    </a>
                                )}
                            </div>
                        )
                    }
                </div>
            </div>
        </header>

        {/* --- MAIN CONTENT GRID --- */}
        <section class="max-w-7xl mx-auto px-6 py-16">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                {/* --- LEFT COLUMN: VISUALS + NARRATIVE (65%) --- */}
                <div class="lg:col-span-8 space-y-16">
                    {/* 1. CINEMA VIEWER (React Component) */}
                    <div class="space-y-4">
                        <ProjectGallery
                            client:load
                            videoUrl={video_url}
                            gallery={gallery}
                            title={finalTitle}
                        />
                    </div>

                    {/* 2. ENGINEERING OWNERSHIP (Featured Section) */}
                    {
                        myRoleText && (
                            <div class="relative pl-6 border-l-4 border-accent bg-gradient-to-r from-orange-500/5 to-transparent py-2">
                                <h2 class="text-sm font-mono font-bold text-accent uppercase tracking-widest mb-4">
                                    {myRoleTitle}
                                </h2>
                                <div class="text-forge-200 text-lg leading-relaxed whitespace-pre-line">
                                    {renderText(myRoleText).map((part: any) =>
                                        part.type === "bold" ? (
                                            <strong class="text-white font-bold">
                                                {part.content}
                                            </strong>
                                        ) : (
                                            part.content
                                        ),
                                    )}
                                </div>
                            </div>
                        )
                    }

                    {/* 3. NARRATIVE (Overview + Slot) */}
                    <div class="space-y-8">
                        {
                            t.overview_text && (
                                <div>
                                    <h2 class="text-2xl font-display font-bold text-white mb-6">
                                        {overviewTitle}
                                    </h2>
                                    <div class="prose prose-invert prose-lg max-w-none text-forge-200 leading-relaxed whitespace-pre-line text-justify">
                                        {renderText(t.overview_text).map(
                                            (part: any) =>
                                                part.type === "bold" ? (
                                                    <strong class="text-white font-bold">
                                                        {part.content}
                                                    </strong>
                                                ) : (
                                                    part.content
                                                ),
                                        )}
                                    </div>
                                </div>
                            )
                        }

                        <div
                            class="prose prose-invert prose-lg max-w-none text-forge-200"
                        >
                            <slot />
                        </div>
                    </div>

                    {/* 4. IMPLEMENTATION HIGHLIGHTS (Impact Cards) */}
                    {
                        t.key_features && t.key_features.length > 0 && (
                            <div>
                                <h3 class="text-2xl font-display font-bold text-white mb-6">
                                    {featuresTitle}
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {t.key_features.map((feature: any) => {
                                        const icon = getFeatureIcon(
                                            feature.title,
                                        );
                                        return (
                                            <div class="bg-forge-900/30 p-6 rounded-xl border border-forge-800/50 hover:border-accent/40 hover:bg-forge-900/50 transition-all group h-full">
                                                <div class="flex items-start gap-4 mb-3">
                                                    <div class="p-2 bg-forge-800 rounded-lg text-accent group-hover:scale-110 transition-transform">
                                                        {/* Simple Icon Logic */}
                                                        {icon === "cloud" && (
                                                            <svg
                                                                xmlns="http://www.w3.org/2000/svg"
                                                                class="w-6 h-6"
                                                                fill="none"
                                                                viewBox="0 0 24 24"
                                                                stroke="currentColor"
                                                            >
                                                                <path
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    stroke-width="1.5"
                                                                    d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"
                                                                />
                                                            </svg>
                                                        )}
                                                        {icon ===
                                                            "architecture" && (
                                                            <svg
                                                                xmlns="http://www.w3.org/2000/svg"
                                                                class="w-6 h-6"
                                                                fill="none"
                                                                viewBox="0 0 24 24"
                                                                stroke="currentColor"
                                                            >
                                                                <path
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    stroke-width="1.5"
                                                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                                                                />
                                                            </svg>
                                                        )}
                                                        {icon === "shield" && (
                                                            <svg
                                                                xmlns="http://www.w3.org/2000/svg"
                                                                class="w-6 h-6"
                                                                fill="none"
                                                                viewBox="0 0 24 24"
                                                                stroke="currentColor"
                                                            >
                                                                <path
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    stroke-width="1.5"
                                                                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                                                                />
                                                            </svg>
                                                        )}
                                                        {icon ===
                                                            "database" && (
                                                            <svg
                                                                xmlns="http://www.w3.org/2000/svg"
                                                                class="w-6 h-6"
                                                                fill="none"
                                                                viewBox="0 0 24 24"
                                                                stroke="currentColor"
                                                            >
                                                                <path
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    stroke-width="1.5"
                                                                    d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"
                                                                />
                                                            </svg>
                                                        )}
                                                        {icon === "code" && (
                                                            <svg
                                                                xmlns="http://www.w3.org/2000/svg"
                                                                class="w-6 h-6"
                                                                fill="none"
                                                                viewBox="0 0 24 24"
                                                                stroke="currentColor"
                                                            >
                                                                <path
                                                                    stroke-linecap="round"
                                                                    stroke-linejoin="round"
                                                                    stroke-width="1.5"
                                                                    d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"
                                                                />
                                                            </svg>
                                                        )}
                                                    </div>
                                                    <h4 class="text-white font-bold text-lg pt-1 group-hover:text-accent transition-colors">
                                                        {feature.title}
                                                    </h4>
                                                </div>
                                                <p class="text-forge-300 text-sm leading-relaxed pl-[3.5rem]">
                                                    {feature.text}
                                                </p>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )
                    }
                </div>

                {/* --- RIGHT COLUMN: METADATA STACK (35%) --- */}
                <div class="lg:col-span-4 relative">
                    <div class="sticky top-24 space-y-8">
                        {/* Metrics */}
                        {
                            metrics && (
                                <div class="bg-forge-900/20 rounded-xl p-6 border border-forge-800 backdrop-blur-sm">
                                    <h3 class="text-xs font-mono font-bold uppercase tracking-widest text-forge-500 mb-6">
                                        {globalT["project.metrics"]}
                                    </h3>
                                    <div class="space-y-4">
                                        {Array.isArray(metrics)
                                            ? metrics.map((m) => (
                                                  <div class="text-accent font-mono">
                                                      {m}
                                                  </div>
                                              ))
                                            : Object.entries(metrics).map(
                                                  ([k, v]) => (
                                                      <div class="flex justify-between items-center border-b border-forge-800 pb-2 last:border-0 last:pb-0">
                                                          <span class="text-forge-400 capitalize text-sm">
                                                              {k}
                                                          </span>
                                                          <span class="text-white font-mono font-bold">
                                                              {v}
                                                          </span>
                                                      </div>
                                                  ),
                                              )}
                                    </div>
                                </div>
                            )
                        }

                        {/* Stack */}
                        <div
                            class="bg-forge-900/20 rounded-xl p-6 border border-forge-800 backdrop-blur-sm"
                        >
                            <h3
                                class="text-xs font-mono font-bold uppercase tracking-widest text-forge-500 mb-6"
                            >
                                {globalT["project.stack"]}
                            </h3>
                            <div class="flex flex-wrap gap-2">
                                {
                                    tech.map((t: string) => (
                                        <span class="px-3 py-1.5 bg-forge-950 text-forge-300 text-xs font-mono border border-forge-800 rounded-xl">
                                            {t}
                                        </span>
                                    ))
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        {/* --- STEALTH STRIP (Backers) --- */}
        {/* --- STEALTH STRIP (Backers) --- */}
        {
            (hasBackers || (backers && backers.length > 0)) && (
                <div class="w-full border-t border-b border-white/5 bg-transparent py-12">
                    <div class="max-w-7xl mx-auto px-6 text-center">
                        <h3 class="text-[10px] font-mono font-bold uppercase tracking-[0.2em] text-white/30 mb-8">
                            Institutional Backing
                        </h3>
                        {backers && backers.length > 0 ? (
                            <div class="flex flex-wrap justify-center gap-6 items-center">
                                {backers.map((logo: string) => (
                                    <img
                                        src={resolveAssetPath(logo, slug)}
                                        class="h-8 w-auto object-contain grayscale opacity-50 hover:grayscale-0 hover:opacity-100 transition-all duration-500"
                                    />
                                ))}
                            </div>
                        ) : (
                            <div class="flex justify-center">
                                <img
                                    src={resolveAssetPath(
                                        backers_image || "",
                                        slug,
                                    )}
                                    class="max-h-16 w-auto grayscale brightness-200 opacity-60 hover:grayscale-0 hover:opacity-100 transition-all duration-500"
                                />
                            </div>
                        )}
                    </div>
                </div>
            )
        }

        {/* --- FOOTER NAV --- */}
        <div
            class="border-t border-forge-900/50 py-12 text-center bg-forge-950"
        >
            <a
                href={lang === "pt" ? "/pt/#projects" : "/#projects"}
                class="inline-flex items-center gap-2 text-forge-400 hover:text-white transition-colors text-sm font-mono uppercase tracking-widest"
            >
                <span>←</span>
                {globalT["project.back_home"]}
            </a>
        </div>
    </main>
</Layout>
